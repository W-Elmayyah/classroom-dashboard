<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Classroom Gamification Dashboard (Firebase)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a33;
      --card:#111f3e;
      --muted:#8ea0c2;
      --text:#e9f0ff;
      --accent:#4ade80;
      --accent2:#60a5fa;
      --danger:#fb7185;
      --border: rgba(255,255,255,0.08);
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(96,165,250,.25), transparent 60%),
                  radial-gradient(900px 500px at 80% 10%, rgba(74,222,128,.20), transparent 60%),
                  var(--bg);
      color: var(--text);
      padding: 28px 14px 80px;
    }
    .container{ max-width: 1120px; margin:0 auto; }
    h1{
      margin: 6px 0 8px; text-align:center; font-size: clamp(22px, 3vw, 36px);
      letter-spacing:.2px;
    }
    .subtitle{
      text-align:center; color: var(--muted); margin:0 0 18px; line-height:1.4;
    }
    .glass{
      background: rgba(17,31,62,0.60);
      border:1px solid var(--border);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .topbar{
      display:flex; flex-wrap:wrap; gap:12px;
      justify-content:space-between; align-items:center;
      padding: 14px 14px;
      margin: 14px auto 16px;
    }
    .who{ font-weight: 700; font-size: 14px; }
    .hint{ color: var(--muted); font-size: 13px; }
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      font-weight: 600;
    }
    .btn:hover{ background: rgba(255,255,255,0.10); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: rgba(74,222,128,0.18); border-color: rgba(74,222,128,0.35); }
    .btn.primary:hover{ background: rgba(74,222,128,0.25); }
    .btn.blue{ background: rgba(96,165,250,0.18); border-color: rgba(96,165,250,0.35); }
    .btn.blue:hover{ background: rgba(96,165,250,0.25); }
    .btn.danger{ background: rgba(251,113,133,0.16); border-color: rgba(251,113,133,0.35); }
    .btn.danger:hover{ background: rgba(251,113,133,0.24); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .card{
      padding: 14px;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: rgba(17,31,62,0.55);
      box-shadow: 0 10px 28px rgba(0,0,0,.22);
    }
    .authGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
      margin: 12px 0 0;
    }
    input, select{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      outline:none;
    }
    input::placeholder{ color: rgba(233,240,255,.55); }
    select option{ color:#0b1220; }
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin: 14px 0 0; }
    .tab{
      padding: 10px 12px; border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      cursor:pointer; font-weight:700; font-size: 13px;
    }
    .tab.active{ border-color: rgba(96,165,250,0.45); background: rgba(96,165,250,0.18); }
    .tab.hidden{ display:none; }
    .panel{ margin-top: 12px; padding: 14px; }
    .hidden{ display:none !important; }

    table{ width:100%; border-collapse: collapse; margin-top: 12px; overflow:hidden; border-radius: 14px; }
    th, td{
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding: 10px 10px;
      text-align: center;
      font-size: 13px;
    }
    th{ font-weight: 800; background: rgba(255,255,255,0.06); }
    tbody tr:hover{ background: rgba(255,255,255,0.04); cursor:pointer; }

    .rankBadge{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:28px; height:28px;
      border-radius: 999px;
      font-weight: 900;
      background: rgba(255,255,255,0.08);
      border:1px solid var(--border);
    }
    .gold{ background: rgba(250,204,21,0.18) !important; }
    .silver{ background: rgba(148,163,184,0.18) !important; }
    .bronze{ background: rgba(251,146,60,0.18) !important; }

    .gridCards{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .teamCardHeader{ display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .teamEmoji{ font-size: 32px; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 4px 10px; border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border:1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      font-weight:700;
    }
    .avatars{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .avatarBtn{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 20px;
      cursor:pointer;
    }
    .avatarBtn.selected{
      border-color: rgba(74,222,128,0.55);
      box-shadow: 0 0 0 4px rgba(74,222,128,0.18);
      background: rgba(74,222,128,0.10);
    }
    .toast{
      position: fixed; left: 50%; bottom: 18px;
      transform: translateX(-50%);
      background: rgba(17,31,62,0.9);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 10px 14px;
      color: var(--text);
      box-shadow: var(--shadow);
      display:none;
      max-width: 92vw;
      font-size: 13px;
    }
    .overlay{
      display:none; position: fixed; inset:0;
      background: rgba(0,0,0,0.55);
      z-index: 999;
    }
    .modal{
      display:none; position: fixed; left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      width: min(520px, 92vw);
      padding: 14px;
    }
    .modalActions{ display:flex; justify-content:flex-end; gap:10px; margin-top: 12px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <div class="container">
    <h1>üèÜ Classroom Gamification Dashboard</h1>
    <p class="subtitle">
      Scoring: <b>1 XP = 1 point</b> ¬∑ <b>1 Star = 5 points</b><br/>
      <span class="hint">Students: Dashboard only ¬∑ Teacher: full access (Teams, Activities, Members)</span>
    </p>

    <div class="topbar glass" id="topbar">
      <div>
        <div class="who" id="whoami">Not signed in</div>
        <div class="hint" id="rolehint">Sign in to start.</div>
      </div>
      <div class="row">
        <button class="btn blue" id="openAuthBtn" onclick="toggleAuth(true)">Sign in / Register</button>
        <button class="btn danger hidden" id="logoutBtn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="card glass" id="authCard">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
        <div>
          <div style="font-weight:900; font-size:16px;">Sign in / Register</div>
          <div class="hint">Uses Firebase Auth (email + password). Your data syncs for everyone.</div>
        </div>
        <button class="btn" onclick="toggleAuth(false)">Close</button>
      </div>

      <div class="authGrid">
        <div class="card">
          <div style="font-weight:800; margin-bottom:8px;">Login</div>
          <input type="email" id="loginEmail" placeholder="Email" />
          <div style="height:8px;"></div>
          <input type="password" id="loginPass" placeholder="Password" />
          <div style="height:10px;"></div>
          <button class="btn primary" style="width:100%;" onclick="login()">Login</button>
          <div class="hint" style="margin-top:8px;">Forgot password? Add reset later if needed.</div>
        </div>

        <div class="card">
          <div style="font-weight:800; margin-bottom:8px;">Student registration</div>
          <input type="text" id="regName" placeholder="Full name" />
          <div style="height:8px;"></div>
          <input type="email" id="regEmail" placeholder="Email" />
          <div style="height:8px;"></div>
          <input type="password" id="regPass" placeholder="Password (min 6 chars)" />
          <div style="height:10px;"></div>

          <div class="hint" style="margin-bottom:6px;">Team choice</div>
          <label class="hint" style="display:block; margin:4px 0;">
            <input type="radio" name="teamMode" value="existing" checked onchange="toggleTeamMode()"> Join an existing team
          </label>
          <select id="regTeamSelect" onchange="syncTeamNameFromMode()"></select>

          <label class="hint" style="display:block; margin:10px 0 4px;">
            <input type="radio" name="teamMode" value="new" onchange="toggleTeamMode()"> Create a new team
          </label>
          <input type="text" id="regTeamNew" placeholder="New team name" oninput="syncTeamNameFromMode()" />
          <input type="hidden" id="regTeam" />

          <div class="hint" style="margin-top:10px;">Choose an avatar</div>
          <div class="avatars" id="avatarPicker"></div>
          <input type="hidden" id="regAvatar" />

          <div style="height:10px;"></div>
          <button class="btn primary" style="width:100%;" onclick="registerStudent()">Register</button>
          <div class="hint" id="regMsg" style="margin-top:8px;"></div>
        </div>

        <div class="card">
          <div style="font-weight:800; margin-bottom:8px;">Teacher setup</div>
          <div class="hint" style="line-height:1.5;">
            Teacher access is controlled by Firestore:
            <div class="mono" style="margin-top:6px;">
              users/&lt;uid&gt; : { role: "teacher" }
            </div>
            Create your teacher account, then open Firebase Console ‚Üí Firestore ‚Üí users ‚Üí set role to <b>teacher</b>.
          </div>
          <div style="height:10px;"></div>
          <button class="btn blue" style="width:100%;" onclick="toast('After logging in as teacher, set role=teacher in Firestore users collection.')">How teacher works</button>
        </div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabDashboard" onclick="openTab('Dashboard')">Dashboard</button>
      <button class="tab hidden" id="tabActivities" onclick="openTab('Activities')">Activities & Grading</button>
      <button class="tab hidden" id="tabManage" onclick="openTab('Manage')">Manage</button>
    </div>

    <div id="Dashboard" class="panel glass">
      <div style="display:flex; justify-content:space-between; align-items:end; gap:10px; flex-wrap:wrap;">
        <div>
          <div style="font-weight:900; font-size:18px;">Global Leaderboard</div>
          <div class="hint">Click a team row to see score breakdown.</div>
        </div>
        <div class="pill" id="syncStatus">üîÑ Sync: connecting‚Ä¶</div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:90px;">Rank</th>
            <th style="text-align:left;">Team</th>
            <th>Total Score</th>
            <th>Total XP</th>
            <th>Total Stars</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody">
          <tr><td colspan="5" class="hint">Loading‚Ä¶</td></tr>
        </tbody>
      </table>

      <div style="height:14px;"></div>

      <div class="card">
        <div style="font-weight:900;">Teams (members)</div>
        <div class="gridCards" id="teamCards"></div>
      </div>
    </div>

    <div id="Activities" class="panel glass hidden">
      <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:end;">
        <div>
          <div style="font-weight:900; font-size:18px;">Activities & Grading</div>
          <div class="hint">Teacher only. Select an activity to grade teams.</div>
        </div>
        <div style="min-width:260px;">
          <select id="activitySelect" onchange="loadActivity()"></select>
        </div>
      </div>

      <div id="activityContainer" class="card" style="margin-top:12px; display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div style="font-weight:900;" id="currentActivityName">Grading</div>
          <div class="hint">Changes sync instantly.</div>
        </div>

        <table>
          <thead>
            <tr>
              <th style="text-align:left;">Team</th>
              <th>Attend</th>
              <th>XP (0‚Äì10)</th>
              <th>Stars (0‚Äì3)</th>
              <th style="text-align:left;">Feedback</th>
            </tr>
          </thead>
          <tbody id="activityTbody"></tbody>
        </table>
      </div>

      <div id="noActivityMessage" class="hint" style="margin-top:14px;">‚Üê Select an activity to start grading.</div>
    </div>

    <div id="Manage" class="panel glass hidden">
      <div style="font-weight:900; font-size:18px;">Manage (Teacher)</div>
      <div class="hint">Teams, activities, and students. Changes sync instantly.</div>

      <div class="authGrid" style="margin-top:12px;">
        <div class="card">
          <div style="font-weight:800; margin-bottom:8px;">Add team</div>
          <input type="text" id="newTeam" placeholder="Team name" />
          <div style="height:10px;"></div>
          <button class="btn primary" style="width:100%;" onclick="addTeam()">Add Team</button>
        </div>

        <div class="card">
          <div style="font-weight:800; margin-bottom:8px;">Add activity</div>
          <input type="text" id="newActivity" placeholder="Activity name (e.g., Activity 01)" />
          <div style="height:10px;"></div>
          <button class="btn primary" style="width:100%;" onclick="addActivity()">Add Activity</button>
          <div class="hint" style="margin-top:8px;">Tip: Create activities before grading.</div>
        </div>

        <div class="card">
          <div style="font-weight:800; margin-bottom:8px;">Danger zone</div>
          <button class="btn danger" style="width:100%;" onclick="resetAllFirebase()">Reset ALL Cloud Data</button>
          <div class="hint" style="margin-top:8px;">Deletes teams, activities, scores, users metadata (not auth accounts).</div>
        </div>
      </div>

      <div style="height:12px;"></div>

      <div class="card">
        <div style="font-weight:900;">Manage teams</div>
        <div class="hint">Rename or delete teams (deleting also removes team scores and clears users' team).</div>
        <div id="manageTeamsList" style="margin-top:10px;"></div>
      </div>

      <div style="height:12px;"></div>

      <div class="card">
        <div style="font-weight:900;">Manage users</div>
        <div class="row" style="align-items:end; margin-top:10px;">
          <div style="min-width:220px; flex:1;">
            <div class="hint">Filter by team</div>
            <select id="memberTeamFilter" onchange="renderMembersTable()"></select>
          </div>
          <div style="min-width:260px; flex:2;">
            <div class="hint">Search</div>
            <input type="text" id="memberSearch" placeholder="Search name or email..." oninput="renderMembersTable()" />
          </div>
        </div>

        <div style="overflow:auto; margin-top:12px;">
          <table style="min-width:780px;">
            <thead>
              <tr>
                <th style="text-align:left;">Name</th>
                <th style="text-align:left;">Email</th>
                <th>Team</th>
                <th>Avatar</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="membersTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay" onclick="closeModal()"></div>
  <div class="modal card glass" id="modal">
    <div id="modalTitle" style="font-weight:900; font-size:16px;">Details</div>
    <div id="modalBody" class="hint" style="margin-top:10px; line-height:1.55;"></div>
    <div class="modalActions">
      <button class="btn" onclick="closeModal()">Close</button>
    </div>
  </div>

  <div class="overlay" id="memberOverlay" onclick="closeMemberModal()"></div>
  <div class="modal card glass" id="memberModal" style="width:min(560px, 92vw);">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div>
        <div style="font-weight:900; font-size:16px;">Edit user</div>
        <div class="hint" id="editMemberEmailHint"></div>
      </div>
      <button class="btn" onclick="closeMemberModal()">Close</button>
    </div>

    <div style="height:10px;"></div>

    <div class="hint">Name</div>
    <input type="text" id="editMemberName" />

    <div style="height:10px;"></div>

    <div class="hint">Team</div>
    <select id="editMemberTeam"></select>
    <div style="height:6px;"></div>
    <div class="hint">Or create new team</div>
    <input type="text" id="editMemberNewTeam" placeholder="New team name (optional)" />

    <div style="height:10px;"></div>

    <div class="hint">Avatar</div>
    <div class="avatars" id="editAvatarPicker"></div>
    <input type="hidden" id="editMemberAvatar" />

    <div class="modalActions">
      <button class="btn danger" onclick="closeMemberModal()">Cancel</button>
      <button class="btn primary" onclick="saveMemberEdits()">Save</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
  apiKey: "AIzaSyATbyd5swZj_C637aUTvtjERz_Lmo1fIMQ",
  authDomain: "champions-bah-717c8.firebaseapp.com",
  databaseURL: "https://champions-bah-717c8-default-rtdb.firebaseio.com",
  projectId: "champions-bah-717c8",
  storageBucket: "champions-bah-717c8.firebasestorage.app",
  messagingSenderId: "943853060966",
  appId: "1:943853060966:web:2c9df5b4e2a5ea4a797ea7",
  measurementId: "G-8Z156RYCP4"
    };

    const AVATARS = ["ü¶Å","ü¶ä","üêØ","üêº","üê∏","ü¶â","üê∫","üê≤","ü¶Ö","üêô","üêù","ü¶Ñ","üê¨","üê¢","ü¶ñ","üê®"];
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let state = { teams: [], activities: [], users: {}, role:"guest", me:null };
    let unsub = [];
    let currentActivityId = "";
    window.__scores = {};

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function toast(msg){
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => t.style.display = "none", 3000);
    }
    function showSync(ok=true){
      const el = document.getElementById("syncStatus");
      el.textContent = ok ? "‚úÖ Sync: live" : "üîÑ Sync: connecting‚Ä¶";
    }
    function openModal(title, html){
      document.getElementById("modalTitle").textContent = title;
      document.getElementById("modalBody").innerHTML = html;
      document.getElementById("overlay").style.display = "block";
      document.getElementById("modal").style.display = "block";
    }
    function closeModal(){
      document.getElementById("overlay").style.display = "none";
      document.getElementById("modal").style.display = "none";
    }
    function toggleAuth(show){
      document.getElementById("authCard").classList.toggle("hidden", !show);
      if (show) window.scrollTo({top:0, behavior:"smooth"});
    }

    function setRegMsg(msg, isError=false){
      const el = document.getElementById("regMsg");
      el.textContent = msg;
      el.style.color = isError ? "#fecaca" : "#bbf7d0";
    }

    function renderAvatarPicker(){
      const wrap = document.getElementById("avatarPicker");
      wrap.innerHTML = "";
      const hidden = document.getElementById("regAvatar");
      if (!hidden.value) hidden.value = AVATARS[0];
      AVATARS.forEach(a => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "avatarBtn" + (hidden.value === a ? " selected" : "");
        btn.textContent = a;
        btn.onclick = () => { hidden.value = a; renderAvatarPicker(); };
        wrap.appendChild(btn);
      });
    }

    function renderTeamSelect(){
      const sel = document.getElementById("regTeamSelect");
      const prev = sel.value;
      sel.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = state.teams.length ? "-- Select a team --" : "-- No teams yet --";
      sel.appendChild(placeholder);
      state.teams.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        sel.appendChild(opt);
      });
      if (prev && state.teams.some(t => t.id === prev)) sel.value = prev;
      syncTeamNameFromMode();
    }

    function toggleTeamMode(){
      const mode = document.querySelector('input[name="teamMode"]:checked')?.value || "existing";
      document.getElementById("regTeamSelect").disabled = (mode !== "existing");
      document.getElementById("regTeamNew").disabled = (mode !== "new");
      syncTeamNameFromMode();
    }

    function syncTeamNameFromMode(){
      const mode = document.querySelector('input[name="teamMode"]:checked')?.value || "existing";
      const hidden = document.getElementById("regTeam");
      const selectedTeamId = document.getElementById("regTeamSelect").value;
      const newTeamName = document.getElementById("regTeamNew").value.trim();
      hidden.value = mode === "existing" ? selectedTeamId : newTeamName;
    }

    function slugify(name){
      return String(name).trim().toLowerCase()
        .replaceAll(/[^a-z0-9]+/g, "-")
        .replaceAll(/(^-|-$)/g, "")
        .slice(0, 40) || ("team-" + Math.random().toString(36).slice(2,8));
    }

    function requireTeacher(){
      if (state.role !== "teacher") { toast("Teacher only."); return false; }
      return true;
    }

    async function registerStudent(){
      const name = document.getElementById("regName").value.trim();
      const email = document.getElementById("regEmail").value.trim().toLowerCase();
      const pass = document.getElementById("regPass").value;
      const avatar = document.getElementById("regAvatar").value || AVATARS[0];

      syncTeamNameFromMode();
      const mode = document.querySelector('input[name="teamMode"]:checked')?.value || "existing";
      const teamChoice = document.getElementById("regTeam").value.trim();

      if (!name || !email || !pass) return setRegMsg("Please enter name, email, and password.", true);
      if (!/^\S+@\S+\.\S+$/.test(email)) return setRegMsg("Please enter a valid email.", true);
      if (pass.length < 6) return setRegMsg("Password must be at least 6 characters.", true);

      if (!teamChoice) {
        return setRegMsg(mode === "existing"
          ? "Please select a team, or switch to Create a new team."
          : "Please enter a new team name.", true);
      }

      try{
        setRegMsg("Creating account‚Ä¶");
        const cred = await auth.createUserWithEmailAndPassword(email, pass);

        let teamId = "";
        if (mode === "existing") {
          teamId = teamChoice;
          if (!state.teams.some(t => t.id === teamId)) throw new Error("Selected team no longer exists. Try again.");
        } else {
          const newName = teamChoice;
          teamId = slugify(newName);
          await db.collection("teams").doc(teamId).set({
            name: newName, avatar: avatar,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        }

        await db.collection("users").doc(cred.user.uid).set({
          name, email, teamId, avatar,
          role: "student",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        setRegMsg("Registered! You are now signed in.");
        toggleAuth(false);
        toast("Welcome!");
      } catch(e){
        console.error(e);
        setRegMsg(e.message || "Registration failed.", true);
      }
    }

    async function login(){
      const email = document.getElementById("loginEmail").value.trim().toLowerCase();
      const pass = document.getElementById("loginPass").value;
      if (!email || !pass) return toast("Enter email and password.");
      try{
        await auth.signInWithEmailAndPassword(email, pass);
        toggleAuth(false);
      } catch(e){
        console.error(e);
        toast(e.message || "Login failed.");
      }
    }

    async function logout(){
      await auth.signOut();
      toast("Signed out.");
    }

    function clearListeners(){
      unsub.forEach(fn => { try{ fn(); }catch(e){} });
      unsub = [];
    }

    function setRoleUI(){
      const who = document.getElementById("whoami");
      const rolehint = document.getElementById("rolehint");
      const logoutBtn = document.getElementById("logoutBtn");
      const openAuthBtn = document.getElementById("openAuthBtn");
      const tabActivities = document.getElementById("tabActivities");
      const tabManage = document.getElementById("tabManage");

      if (state.role === "teacher") {
        who.textContent = `Signed in as: Teacher (${state.me?.email || ""})`;
        rolehint.textContent = "Teacher mode: full access.";
        logoutBtn.classList.remove("hidden");
        openAuthBtn.classList.add("hidden");
        tabActivities.classList.remove("hidden");
        tabManage.classList.remove("hidden");
      } else if (state.role === "student") {
        const teamName = state.teams.find(t => t.id === state.me?.teamId)?.name || state.me?.teamId || "";
        who.textContent = `Signed in as: ${state.me?.name || "Student"} ‚Äî ${state.me?.avatar || ""} (${state.me?.email || ""})`;
        rolehint.textContent = `Student mode: Dashboard only. Team: ${teamName || "‚Äî"}`;
        logoutBtn.classList.remove("hidden");
        openAuthBtn.classList.add("hidden");
        tabActivities.classList.add("hidden");
        tabManage.classList.add("hidden");
        openTab("Dashboard");
      } else {
        who.textContent = "Not signed in";
        rolehint.textContent = "Sign in to start. Students: Dashboard only ¬∑ Teacher: full access.";
        logoutBtn.classList.add("hidden");
        openAuthBtn.classList.remove("hidden");
        tabActivities.classList.add("hidden");
        tabManage.classList.add("hidden");
        openTab("Dashboard");
      }
    }

    function openTab(name){
      ["Dashboard","Activities","Manage"].forEach(id => {
        document.getElementById(id).classList.toggle("hidden", id !== name);
      });
      document.getElementById("tabDashboard").classList.toggle("active", name==="Dashboard");
      document.getElementById("tabActivities").classList.toggle("active", name==="Activities");
      document.getElementById("tabManage").classList.toggle("active", name==="Manage");
    }

    function startRealtime(){
      clearListeners();
      showSync(false);

      unsub.push(db.collection("teams").onSnapshot(snap => {
        const arr = [];
        snap.forEach(doc => {
          const d = doc.data() || {};
          arr.push({ id: doc.id, name: d.name || doc.id, avatar: d.avatar || "üë•" });
        });
        arr.sort((a,b) => a.name.localeCompare(b.name));
        state.teams = arr;
        renderTeamSelect();
        renderTeamCards();
        updateLeaderboard();
        renderManageTeamsList();
        renderMemberTeamFilter();
        renderMembersTable();
      }));

      unsub.push(db.collection("activities").onSnapshot(snap => {
        const arr = [];
        snap.forEach(doc => {
          const d = doc.data() || {};
          arr.push({ id: doc.id, name: d.name || doc.id });
        });
        arr.sort((a,b) => a.name.localeCompare(b.name));
        state.activities = arr;
        renderActivitySelect();
        updateLeaderboard();
      }));

      unsub.push(db.collection("users").onSnapshot(snap => {
        const u = {};
        snap.forEach(doc => u[doc.id] = doc.data() || {});
        state.users = u;
        renderTeamCards();
        renderManageTeamsList();
        renderMemberTeamFilter();
        renderMembersTable();
      }));

      unsub.push(db.collection("scores").onSnapshot(snap => {
        window.__scores = {};
        snap.forEach(doc => window.__scores[doc.id] = doc.data() || {});
        updateLeaderboard();
        if (state.role === "teacher" && currentActivityId) loadActivity();
      }));

      showSync(true);
    }

    function getTeamMembers(teamId){
      return Object.values(state.users || {}).filter(u => u.role === "student" && u.teamId === teamId);
    }

    function renderTeamCards(){
      const wrap = document.getElementById("teamCards");
      wrap.innerHTML = "";
      if (!state.teams.length){
        wrap.innerHTML = `<div class="hint">No teams yet. Create one in registration or as teacher.</div>`;
        return;
      }

      state.teams.forEach(t => {
        const members = getTeamMembers(t.id);
        const list = members.slice(0, 8).map(m => `${escapeHtml(m.avatar || "üôÇ")} ${escapeHtml(m.name || m.email)}`).join("<br>");
        const more = members.length > 8 ? `<br><span class="hint">+${members.length - 8} more</span>` : "";

        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="teamCardHeader">
            <div style="display:flex; gap:10px; align-items:center;">
              <div class="teamEmoji">${t.avatar}</div>
              <div>
                <div style="font-weight:900;">${escapeHtml(t.name)}</div>
                <div class="hint">${members.length} member(s)</div>
              </div>
            </div>
            <div class="pill">ID: <span class="mono">${escapeHtml(t.id)}</span></div>
          </div>
          <div class="hint" style="margin-top:10px; line-height:1.6;">
            ${list || "No registered members yet."}${more}
          </div>
        `;
        wrap.appendChild(div);
      });
    }

    function totalsForTeam(teamId){
      let xp=0, stars=0;
      state.activities.forEach(a => {
        const key = `${a.id}__${teamId}`;
        const s = window.__scores[key];
        if (!s) return;
        if (s.attend) xp += (s.xp || 0);
        stars += (s.stars || 0);
      });
      return { xp, stars, score: xp + stars * 5 };
    }

    function updateLeaderboard(){
      const tbody = document.getElementById("leaderboardBody");
      tbody.innerHTML = "";
      if (!state.teams.length){
        tbody.innerHTML = `<tr><td colspan="5" class="hint">No teams yet.</td></tr>`;
        return;
      }

      const rows = state.teams.map(t => ({ team:t, ...totalsForTeam(t.id) }))
        .sort((a,b) => b.score - a.score || b.xp - a.xp || b.stars - a.stars);

      rows.forEach((r, i) => {
        const tr = document.createElement("tr");
        if (i===0) tr.classList.add("gold");
        if (i===1) tr.classList.add("silver");
        if (i===2) tr.classList.add("bronze");

        tr.onclick = () => {
          openModal(`${r.team.avatar} ${r.team.name}`, `
            <div><b>${r.xp}</b> XP √ó 1 = <b>${r.xp}</b> points</div>
            <div style="height:8px;"></div>
            <div><b>${r.stars}</b> ‚≠ê √ó 5 = <b>${r.stars * 5}</b> points</div>
            <div style="height:10px;"></div>
            <div style="font-weight:900;">Total Score: ${r.score}</div>
          `);
        };

        tr.innerHTML = `
          <td><span class="rankBadge">${i+1}</span></td>
          <td style="text-align:left;"><b>${r.team.avatar}</b> ${escapeHtml(r.team.name)}</td>
          <td><b>${r.score}</b></td>
          <td>${r.xp}</td>
          <td>${"‚≠ê".repeat(r.stars)} <span class="hint">(${r.stars})</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderActivitySelect(){
      const sel = document.getElementById("activitySelect");
      sel.innerHTML = `<option value="">-- Select activity --</option>`;
      state.activities.forEach(a => {
        const opt = document.createElement("option");
        opt.value = a.id;
        opt.textContent = a.name;
        sel.appendChild(opt);
      });
      if (currentActivityId) sel.value = currentActivityId;
    }

    function loadActivity(){
      if (state.role !== "teacher") return;
      currentActivityId = document.getElementById("activitySelect").value;

      const cont = document.getElementById("activityContainer");
      const noMsg = document.getElementById("noActivityMessage");
      const tbody = document.getElementById("activityTbody");
      tbody.innerHTML = "";

      if (!currentActivityId){
        cont.style.display = "none";
        noMsg.style.display = "block";
        return;
      }
      cont.style.display = "block";
      noMsg.style.display = "none";

      const actName = state.activities.find(a => a.id === currentActivityId)?.name || currentActivityId;
      document.getElementById("currentActivityName").textContent = `Grading: ${actName}`;

      state.teams.forEach(t => {
        const key = `${currentActivityId}__${t.id}`;
        const s = window.__scores[key] || { attend:false, xp:0, stars:0, feedback:"" };

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="text-align:left;"><b>${t.avatar}</b> ${escapeHtml(t.name)}</td>
          <td><input type="checkbox" ${s.attend ? "checked" : ""} onchange="updateScore('${currentActivityId}','${t.id}','attend', this.checked)"></td>
          <td><input type="number" min="0" max="10" value="${s.attend ? (s.xp||0) : 0}" ${!s.attend ? "disabled" : ""} onchange="updateScore('${currentActivityId}','${t.id}','xp', this.value)"></td>
          <td><input type="number" min="0" max="3" value="${s.stars||0}" onchange="updateScore('${currentActivityId}','${t.id}','stars', this.value)"></td>
          <td><input type="text" value="${escapeHtml(s.feedback || "")}" onchange="updateScore('${currentActivityId}','${t.id}','feedback', this.value)" style="text-align:left;"></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function updateScore(activityId, teamId, field, value){
      if (!requireTeacher()) return;
      const key = `${activityId}__${teamId}`;
      const ref = db.collection("scores").doc(key);

      const cur = window.__scores[key] || { attend:false, xp:0, stars:0, feedback:"" };
      let next = { ...cur };

      if (field === "attend"){
        next.attend = !!value;
        if (!next.attend) next.xp = 0;
      }
      if (field === "xp"){
        const v = Math.max(0, Math.min(10, parseInt(value) || 0));
        if (next.attend) next.xp = v;
      }
      if (field === "stars"){
        next.stars = Math.max(0, Math.min(3, parseInt(value) || 0));
      }
      if (field === "feedback"){
        next.feedback = String(value || "");
      }

      next.activityId = activityId;
      next.teamId = teamId;
      next.updatedAt = firebase.firestore.FieldValue.serverTimestamp();

      await ref.set(next, { merge:true });
    }

    async function addTeam(){
      if (!requireTeacher()) return;
      const name = document.getElementById("newTeam").value.trim();
      if (!name) return toast("Enter team name.");
      const id = slugify(name);
      await db.collection("teams").doc(id).set({
        name, avatar:"üë•", createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
      document.getElementById("newTeam").value = "";
      toast("Team added.");
    }

    async function addActivity(){
      if (!requireTeacher()) return;
      const name = document.getElementById("newActivity").value.trim();
      if (!name) return toast("Enter activity name.");
      const id = slugify(name);
      await db.collection("activities").doc(id).set({
        name, createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
      document.getElementById("newActivity").value = "";
      toast("Activity added.");
    }

    function renderManageTeamsList(){
      const wrap = document.getElementById("manageTeamsList");
      if (!wrap) return;
      if (state.role !== "teacher"){
        wrap.innerHTML = `<div class="hint">Teacher only.</div>`;
        return;
      }
      if (!state.teams.length){
        wrap.innerHTML = `<div class="hint">No teams yet.</div>`;
        return;
      }

      wrap.innerHTML = "";
      state.teams.forEach(t => {
        const members = getTeamMembers(t.id).length;
        const div = document.createElement("div");
        div.className = "card";
        div.style.margin = "10px 0 0 0";
        div.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
            <div style="display:flex; gap:10px; align-items:center;">
              <div style="font-size:28px;">${t.avatar}</div>
              <div>
                <div style="font-weight:900;">${escapeHtml(t.name)} <span class="pill" style="margin-left:8px;">${members} member(s)</span></div>
                <div class="hint">ID: <span class="mono">${escapeHtml(t.id)}</span></div>
              </div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <input type="text" id="rename_${t.id}" placeholder="New team name" style="min-width:220px;">
              <button class="btn blue" onclick="renameTeam('${t.id}')">Rename</button>
              <button class="btn danger" onclick="deleteTeam('${t.id}')">Delete</button>
            </div>
          </div>
        `;
        wrap.appendChild(div);
      });
    }

    async function renameTeam(teamId){
      if (!requireTeacher()) return;
      const input = document.getElementById(`rename_${teamId}`);
      const newName = (input?.value || "").trim();
      if (!newName) return toast("Enter a new team name.");
      await db.collection("teams").doc(teamId).set({ name: newName }, { merge:true });
      toast("Team renamed.");
    }

    async function deleteTeam(teamId){
      if (!requireTeacher()) return;
      const team = state.teams.find(t => t.id === teamId);
      if (!confirm(`Delete team "${team?.name || teamId}"?
This will remove:
- team document
- all scores for this team
- users' team links will be cleared

Proceed?`)) return;

      const batch = db.batch();
      batch.delete(db.collection("teams").doc(teamId));

      Object.entries(state.users || {}).forEach(([uid, u]) => {
        if (u.teamId === teamId) batch.set(db.collection("users").doc(uid), { teamId: "" }, { merge:true });
      });

      Object.keys(window.__scores || {}).forEach(id => {
        const s = window.__scores[id];
        if (s.teamId === teamId) batch.delete(db.collection("scores").doc(id));
      });

      await batch.commit();
      toast("Team deleted.");
    }

    function renderMemberTeamFilter(){
      const sel = document.getElementById("memberTeamFilter");
      if (!sel) return;
      sel.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "__all__";
      optAll.textContent = "All teams";
      sel.appendChild(optAll);
      state.teams.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        sel.appendChild(opt);
      });
    }

    function renderMembersTable(){
      const tbody = document.getElementById("membersTbody");
      if (!tbody) return;
      if (state.role !== "teacher"){
        tbody.innerHTML = `<tr><td colspan="5" class="hint">Teacher only.</td></tr>`;
        return;
      }

      const teamFilter = document.getElementById("memberTeamFilter").value || "__all__";
      const q = (document.getElementById("memberSearch").value || "").trim().toLowerCase();

      const list = Object.entries(state.users || {})
        .map(([uid,u]) => ({ uid, ...u }))
        .filter(u => u.role === "student" || u.role === "teacher")
        .filter(u => teamFilter === "__all__" ? true : (u.teamId === teamFilter))
        .filter(u => !q ? true : (String(u.name||"").toLowerCase().includes(q) || String(u.email||"").toLowerCase().includes(q)))
        .sort((a,b) => String(a.teamId||"").localeCompare(String(b.teamId||"")) || String(a.name||"").localeCompare(String(b.name||"")));

      if (!list.length){
        tbody.innerHTML = `<tr><td colspan="5" class="hint">No users match this filter.</td></tr>`;
        return;
      }

      tbody.innerHTML = "";
      list.forEach(u => {
        const teamName = state.teams.find(t => t.id === u.teamId)?.name || (u.teamId ? u.teamId : "‚Äî");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="text-align:left;">${escapeHtml(u.name || "‚Äî")}</td>
          <td style="text-align:left;">${escapeHtml(u.email || "‚Äî")}</td>
          <td>${escapeHtml(teamName)}</td>
          <td style="font-size:20px;">${escapeHtml(u.avatar || "üôÇ")}</td>
          <td>
            <button class="btn blue" onclick="openMemberModal('${u.uid}')">Edit</button>
            <button class="btn danger" onclick="removeUserFromTeam('${u.uid}')">Remove from team</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function openMemberModal(uid){
      if (!requireTeacher()) return;
      const u = state.users[uid];
      if (!u) return toast("User not found.");

      document.getElementById("memberModal").dataset.uid = uid;
      document.getElementById("editMemberEmailHint").textContent = `UID: ${uid} ¬∑ Email: ${u.email || ""}`;
      document.getElementById("editMemberName").value = u.name || "";
      document.getElementById("editMemberNewTeam").value = "";

      const sel = document.getElementById("editMemberTeam");
      sel.innerHTML = `<option value="">‚Äî No team ‚Äî</option>`;
      state.teams.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        sel.appendChild(opt);
      });
      sel.value = u.teamId || "";

      renderEditAvatarPicker(u.avatar || "üôÇ");

      document.getElementById("memberOverlay").style.display = "block";
      document.getElementById("memberModal").style.display = "block";
    }

    function closeMemberModal(){
      document.getElementById("memberOverlay").style.display = "none";
      document.getElementById("memberModal").style.display = "none";
    }

    function renderEditAvatarPicker(selected){
      const wrap = document.getElementById("editAvatarPicker");
      wrap.innerHTML = "";
      const hidden = document.getElementById("editMemberAvatar");
      hidden.value = selected;

      AVATARS.forEach(a => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "avatarBtn" + (hidden.value === a ? " selected" : "");
        btn.textContent = a;
        btn.onclick = () => { hidden.value = a; renderEditAvatarPicker(a); };
        wrap.appendChild(btn);
      });
    }

    async function saveMemberEdits(){
      if (!requireTeacher()) return;
      const uid = document.getElementById("memberModal").dataset.uid;
      const u = state.users[uid];
      if (!u) return toast("User not found.");

      const newName = document.getElementById("editMemberName").value.trim();
      const newAvatar = document.getElementById("editMemberAvatar").value || "üôÇ";
      const newTeamName = document.getElementById("editMemberNewTeam").value.trim();
      const selectedTeamId = document.getElementById("editMemberTeam").value || "";

      if (!newName) return toast("Name cannot be empty.");

      let teamId = selectedTeamId;
      if (newTeamName){
        teamId = slugify(newTeamName);
        await db.collection("teams").doc(teamId).set({ name: newTeamName, avatar: newAvatar }, { merge:true });
      }

      await db.collection("users").doc(uid).set({
        name: newName, avatar: newAvatar, teamId: teamId
      }, { merge:true });

      toast("User updated.");
      closeMemberModal();
    }

    async function removeUserFromTeam(uid){
      if (!requireTeacher()) return;
      const u = state.users[uid];
      if (!u) return;
      if (!confirm(`Remove ${u.name || u.email} from their team?`)) return;
      await db.collection("users").doc(uid).set({ teamId: "" }, { merge:true });
      toast("Removed from team.");
    }

    async function resetAllFirebase(){
      if (!requireTeacher()) return;
      if (!confirm(`RESET ALL CLOUD DATA?
Deletes teams, activities, scores, and clears teamId in users.
(Does not delete Auth accounts.)

Proceed?`)) return;

      const batch = db.batch();
      const teamsSnap = await db.collection("teams").get();
      teamsSnap.forEach(doc => batch.delete(doc.ref));
      const actSnap = await db.collection("activities").get();
      actSnap.forEach(doc => batch.delete(doc.ref));
      const scoreSnap = await db.collection("scores").get();
      scoreSnap.forEach(doc => batch.delete(doc.ref));
      const usersSnap = await db.collection("users").get();
      usersSnap.forEach(doc => batch.set(doc.ref, { teamId:"" }, { merge:true }));
      await batch.commit();
      toast("Cloud data reset complete.");
    }

    renderAvatarPicker();
    renderTeamSelect();
    toggleTeamMode();
    toggleAuth(true);

    auth.onAuthStateChanged(async user => {
      state.me = null;
      state.role = "guest";
      clearListeners();

      if (!user){
        setRoleUI();
        startRealtime();
        toggleAuth(true);
        return;
      }

      const meRef = db.collection("users").doc(user.uid);
      const meSnap = await meRef.get();
      if (!meSnap.exists){
        await meRef.set({
          email: user.email || "", name: "", role: "student",
          teamId: "", avatar: "üôÇ",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      }

      unsub.push(meRef.onSnapshot(doc => {
        const me = doc.data() || {};
        state.me = { uid: user.uid, ...me };
        state.role = me.role === "teacher" ? "teacher" : "student";
        setRoleUI();
      }));

      startRealtime();
      toggleAuth(false);
      toast("Signed in.");
    });
  </script>
</body>
</html>
